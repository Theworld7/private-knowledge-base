# éåŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆ

## ç†è§£ Proxy å’Œ Reflect

### Proxy

ä½¿ç”¨ Proxy å¯ä»¥åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå®ç°å¯¹**å…¶ä»–å¯¹è±¡**çš„ä»£ç†ï¼Œä¸”åªèƒ½ä»£ç†å¯¹è±¡ã€‚ä»£ç†ï¼ŒæŒ‡çš„æ˜¯å¯¹ä¸€ä¸ªå¯¹è±¡**åŸºæœ¬è¯­ä¹‰**çš„ä»£ç†ã€‚å®ƒå…è®¸æˆ‘ä»¬**æ‹¦æˆª**å¹¶**é‡æ–°å®šä¹‰**å¯¹ä¸€ä¸ªå¯¹è±¡çš„åŸºæœ¬æ“ä½œã€‚

è¯»å–ã€è®¾ç½®å±æ€§å€¼çš„æ“ä½œï¼Œå°±å±äºåŸºæœ¬è¯­ä¹‰çš„æ“ä½œï¼Œå³åŸºæœ¬æ“ä½œã€‚

è°ƒç”¨å¯¹è±¡ä¸‹çš„æ–¹æ³•æ˜¯å…¸å‹çš„éåŸºæœ¬æ“ä½œï¼Œç§°ä¸º**å¤åˆæ“ä½œ**ï¼š`obj.fn()`ã€‚è¯¥å¤åˆæ“ä½œç”±ä¸¤ä¸ªåŸºæœ¬è¯­ä¹‰ç»„æˆï¼Œå…ˆé€šè¿‡ `get` å¾—åˆ° `obj.fn` å±æ€§ã€‚ç„¶åæ˜¯å‡½æ•°è°ƒç”¨ï¼Œå³å‡½æ•°å†…çš„ `apply` æ“ä½œã€‚

### Reflect

Reflect æ˜¯ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œå…·æœ‰è®¸å¤šæ–¹æ³•ï¼š

```javascript
Reflect.get();
Reflect.set();
Reflect.apply();
// ...
```

Reflect å…·æœ‰ Proxy çš„æ‹¦æˆªå™¨ä¸­çš„æ‰€æœ‰æ–¹æ³•ã€‚Reflect.get æä¾›äº†è®¿é—®ä¸€ä¸ªå¯¹è±¡å±æ€§çš„é»˜è®¤è¡Œä¸ºï¼Œå¹¶æä¾› receiver å‚æ•°ï¼š

```javascript
const obj = { foo: 1 }
console.log(Reflect.get(obj, 'foo', { foo: 2 }))  // è¾“å‡ºçš„æ˜¯ 2 è€Œä¸æ˜¯ 1
```

æ ¹æ®ä¹‹å‰å®ç°çš„å“åº”å¼ä»£ç ï¼Œåœ¨ä»£ç†ç›®æ ‡çš„å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªè®¿é—®å™¨å±æ€§ï¼Œè®¿é—®å™¨ä¸­è¯»å–å¯¹è±¡è‡ªèº«çš„å±æ€§ã€‚

```javascript
const obj = {
    foo: 1,
    get bar() {
        return this.foo
    }
}

const p = new Proxy(obj, {
    get(target, key) {
        track(target, key)
        // æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨ Reflect.get å®Œæˆè¯»å–
        return target[key]
    },
    set(target, key, newVal) {
        // è¿™é‡ŒåŒæ ·æ²¡æœ‰ä½¿ç”¨ Reflect.set å®Œæˆè®¾ç½®
        target[key] = newVal
        trigger(target, key)
    }
})

effect(() => {
    console.log(p.bar) // 1
})
```

å½“ `effect` æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šè¯»å– `p.bar` å±æ€§ï¼Œå®ƒå‘ç° `p.bar` æ˜¯ä¸€ä¸ªè®¿é—®å™¨å±æ€§ï¼Œå› æ­¤æ‰§è¡Œ `getter` å‡½æ•°ã€‚ç”±äºåœ¨ `getter` å‡½æ•°ä¸­é€šè¿‡ `this.foo` è¯»å–äº† `foo` å±æ€§å€¼ï¼Œå› æ­¤ç›´è§‰ä¸Šå‰¯ä½œç”¨å‡½æ•°åº”ä¸å±æ€§ `foo` ä¹‹é—´ä¹Ÿä¼šå»ºç«‹è”ç³»ã€‚

æ­¤æ—¶ `this` æŒ‡å‘åŸå§‹å¯¹è±¡ `obj` ï¼Œç”±äº `ob j` æ˜¯åŸå§‹æ•°æ®ï¼Œä¸æ˜¯ä»£ç†å¯¹è±¡ï¼Œè¯¥è®¿é—®ä¸èƒ½å»ºç«‹å“åº”è”ç³»ã€‚

ä½¿ç”¨ `Reflect.get` è§£å†³è¯¥é—®é¢˜ï¼š

```javascript
const p = new Proxy(obj, {
    // æ‹¦æˆªè¯»å–æ“ä½œï¼Œæ¥æ”¶ç¬¬ä¸‰ä¸ªå‚æ•° receiver
    get(target, key, receiver) {
        track(target, key)
        // ä½¿ç”¨ Reflect.get è¿”å›è¯»å–åˆ°çš„å±æ€§å€¼
        return Reflect.get(target, key, receiver)
    },
    // çœç•¥éƒ¨åˆ†ä»£ç 
})
```

ä»£ç†å¯¹è±¡çš„ `get` æ‹¦æˆªå‡½æ•°æ¥æ”¶ç¬¬ä¸‰ä¸ªå‚æ•° `receiver` ï¼Œä»£è¡¨è°åœ¨è¯»å–å±æ€§ï¼Œæ­¤æ—¶ä¸º `p` ã€‚ ç”±äºä½¿ç”¨ `Reflect.get(target, key, receiver)` ä»£æ›¿ä¹‹å‰çš„ `target[key]` ï¼Œæ‰€ä»¥è®¿é—®å™¨å±æ€§ `bar` çš„ `getter` å‡½æ•°å†…çš„ `this` æŒ‡å‘ä»£ç†å¯¹è±¡ `p` ã€‚

### JavaScript å¯¹è±¡åŠ Proxy çš„å·¥ä½œåŸç†

Javascript ä¸­åŒ…å«ä¸¤ç§å¯¹è±¡ï¼Œ**å¸¸è§„å¯¹è±¡**ã€**å¼‚è´¨å¯¹è±¡**ã€‚Javascript å¯¹è±¡çš„å®é™…è¯­ä¹‰ç”±**å†…éƒ¨æ–¹æ³•**åˆ¶å®šçš„ã€‚å†…éƒ¨æ–¹æ³•å½“ä¸€ä¸ªå¯¹è±¡è¢«æ‰§è¡Œæ“ä½œæ—¶å¼•æ“å†…éƒ¨è°ƒç”¨çš„æ–¹æ³•ã€‚

è®¿é—®å¯¹è±¡å±æ€§æ—¶ï¼š`obj.foo` ï¼Œå¼•æ“å†…éƒ¨ä¼šè°ƒç”¨ `[[Get]]` æ–¹æ³•ã€‚

| å†…éƒ¨æ–¹æ³•                    | ç­¾å                                               | æè¿°                                                                                                                           |
| ----------------------- | ------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------- |
| `[[ GetPrototypeOf ]]`  | `() => Object/Null`                              | æŸ¥æ˜ä¸ºè¯¥å¯¹è±¡æä¾›ç»§æ‰¿å±æ€§çš„å¯¹è±¡ï¼Œnull ä»£è¡¨æ²¡æœ‰ç»§æ‰¿å±æ€§                                                                                                |
| `[[SetprototypeOf]]`    | `(Object/Null)Â =>Â Boolean`                       | å°†è¯¥å¯¹è±¡ä¸æä¾›ç»§æ‰¿å±æ€§çš„å¦ä¸€ä¸ªå¯¹è±¡ç›¸å…³è”ã€‚ä¼ é€’ null è¡¨ç¤ºæ²¡æœ‰ç»§æ‰¿å±æ€§ï¼Œè¿”å› true è¡¨ç¤ºæ“ä½œæˆåŠŸå®Œæˆï¼Œè¿”å› false è¡¨ç¤ºæ“ä½œå¤±è´¥                                                       |
| `[[IsExtensible]]`      | `() =>Â Boolean`                                  | æŸ¥æ˜æ˜¯å¦å…è®¸å‘è¯¥å¯¹è±¡æ·»åŠ å…¶ä»–å±æ€§                                                                                                             |
| `[[PreventExtensions]]` | `()Â =>Â Boolean`                                  | æ§åˆ¶èƒ½å¦å‘è¯¥å¯¹è±¡æ·»åŠ å±æ€§ã€‚å¦‚æœæ“ä½œæˆåŠŸåˆ™è¿”å› true ï¼Œå¦‚æœæ“ä½œå¤±è´¥åˆ™è¿”å› false                                                                                 |
| `[[GetOwnProperty]]`    | `(propertyKey)Â =>Â Undefined/PropertyÂ Descriptor` | è¿”å›è¯¥å¯¹è±¡è‡ªèº«å±æ€§çš„æè¿°ç¬¦,å…¶é”®ä¸ºpropetyKey ,å¦‚æœä¸å­˜åœ¨è¿™æ ·çš„å±æ€§,åˆ™è¿”å› undefined                                                                        |
| `[[DefineOwnProperty]]` | `(propertyKey, PropertyDescriptor)Â =>Â Boolean`   | åˆ›å»ºæˆ–æ›´æ”¹è‡ªå·±çš„å±æ€§ï¼Œå…¶é”®ä¸º ropertyKey ï¼Œä»¥å…·æœ‰ç”± PropertyDescriptor æè¿°çš„çŠ¶æ€ã€‚å¦‚æœ è¯¥å±æ€§å·²æˆåŠŸåˆ›å»ºæˆ–æ›´æ–°ï¼Œåˆ™è¿”å›true ï¼›å¦‚æœæ— æ³•åˆ›å»ºæˆ–æ›´æ–°è¯¥å±æ€§,åˆ™è¿”å› false                      |
| `[[HasProperty]]`       | `(propertyKey)Â =>Â Boolean`                       | è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºè¯¥å¯¹è±¡æ˜¯å¦å·²ç»æ‹¥æœ‰é”®ä¸º propertyKey çš„è‡ªå·±çš„æˆ–ç»´æ‰¿çš„å±æ€§                                                                                 |
| `[[Get]]`               | `(propertyKey, Receiver)Â => any`                 | ä»è¯¥å¯¹è±¡è¿”å›é”®ä¸º propetyKey çš„å±æ€§çš„å€¼ã€‚å¦‚æœå¿…é¡»è¿è¡Œ ECMASript ä»£ç æ¥æ£€ç´¢å±æ€§å€¼, åˆ™åœ¨è¿è¡Œä»£ç æ—¶ä½¿ç”¨  Receiver ä½œä¸º this å€¼                                           |
| `[[Set]]`               | `(propertyKey, value, Receiver)Â =>Â Boolean`      | å°†é”®å€¼ä¸º popertyKey çš„å±æ€§çš„å€¼è®¾ç½®ä¸º value ã€‚å¦‚æœå¿…é¡»è¿è¡Œ ECMAScipt ä»£ç æ¥è®¾ç½®å±æ€§å€¼ï¼Œåˆ™åœ¨è¿è¡Œä»£ç æ—¶ä½¿ç”¨ Receiver ä½œä¸º this å€¼ã€‚å¦‚æœæˆåŠŸè®¾ç½®äº†å±æ€§å€¼,åˆ™è¿”å› true ï¼›å¦‚æœæ— æ³•è®¾ç½®ï¼Œåˆ™è¿”å› false |
| `[[Delete]]`            | `(propertyKey)Â =>Â Boolean`                       | ä»è¯¥å¯¹è±¡ä¸­åˆ é™¤å±äºè‡ªèº«çš„é”®ä¸º prepertyKey çš„å±æ€§ã€‚å¦‚æœè¯¥å±æ€§æœªè¢«åˆ é™¤å¹¶ä¸”ä»ç„¶å­˜åœ¨ï¼Œåˆ™è¿”å› false ï¼›å¦‚æœè¯¥å±æ€§å·²è¢«åˆ é™¤æˆ–ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› true                                             |
| `[[OwnPropertyKeys]]`   | `()Â =>Â ListÂ ofÂ propertyKey`                      | è¿”å›ä¸€ä¸ª List ï¼Œå…¶å…ƒç´ éƒ½æ˜¯å¯¹è±¡è‡ªèº«çš„å±æ€§é”®                                                                                                     |

é¢å¤–çš„å¿…è¦å†…éƒ¨æ–¹æ³•ï¼š

| å†…éƒ¨æ–¹æ³•            | ç­¾å                                  | æè¿°                                                                                                                      |
| --------------- | ----------------------------------- | ----------------------------------------------------------------------------------------------------------------------- |
| `[[Call]]`      | `(any, a List of any)Â =>Â any`       | å°†è¿è¡Œçš„ä»£ç ä¸ this å¯¹è±¡å…³è”ã€‚ç”±å‡½æ•°è°ƒç”¨è§¦å‘ã€‚è¯¥å†…éƒ¨æ–¹æ³•çš„å‚æ•°æ˜¯ä¸€ä¸ª this å€¼å’Œå‚æ•°åˆ—è¡¨                                                                       |
| `[[Construct]]` | `(a List of any, Object)Â =>Â Object` | åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚é€šè¿‡ new è¿ç®—ç¬¦æˆ– super è°ƒç”¨è§¦å‘ã€‚è¯¥å†…éƒ¨æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª List ï¼Œè¯¥ List çš„å…ƒç´ æ˜¯æ„é€ å‡½æ•°è°ƒç”¨æˆ– super è°ƒç”¨çš„å‚æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æœ€åˆåº”ç”¨ new è¿ç®—ç¬¦çš„å¯¹è±¡ã€‚å®ç°è¯¥å†…éƒ¨æ–¹æ³•çš„å¯¹è±¡ç§°ä¸ºæ„é€ å‡½æ•° |

å¦‚æœä¸€ä¸ªå¯¹è±¡éœ€è¦ä½œä¸ºå‡½æ•°è°ƒç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±å¿…é¡»éƒ¨ç½²å†…éƒ¨æ–¹æ³• `[[Call]]` ã€‚

å†…éƒ¨æ–¹æ³•å…·æœ‰å¤šæ€æ€§ï¼Œä¸åŒç±»å‹çš„å¯¹è±¡å¯èƒ½ä¸è¾“äº†ç›¸åŒçš„å†…éƒ¨æ–¹æ³•ï¼Œå´å…·æœ‰ä¸åŒçš„é€»è¾‘ã€‚

å¸¸è§„å¯¹è±¡éœ€è¦æ»¡è¶³çš„è¦æ±‚ï¼š

* å¯¹äºä¸Šè¿°å†…éƒ¨æ–¹æ³•ï¼Œå¿…é¡»ä½¿ç”¨ ECMA è§„èŒƒ 10.1.x èŠ‚ç»™å‡ºçš„å®šä¹‰å®ç°ï¼›
* å¯¹äºå†…éƒ¨æ–¹æ³• `[[Call]]` ï¼Œå¿…é¡»ä½¿ç”¨ ECMA è§„èŒƒ 10.2.1 èŠ‚ç»™å‡ºçš„å®šä¹‰å®ç°ï¼›
* å¯¹äºå†…éƒ¨æ–¹æ³• `[[Construct]]` ï¼Œå¿…é¡»ä½¿ç”¨ ECMA è§„èŒƒ 10.2.2 èŠ‚ç»™å‡ºçš„å®šä¹‰å®ç°ã€‚

ä¸ç¬¦åˆä»¥ä¸Šè¦æ±‚çš„éƒ½æ˜¯å¼‚è´¨å¯¹è±¡ã€‚ç”±äº Proxy çš„å†…éƒ¨æ–¹æ³• `[[Get]]` æ²¡æœ‰ä½¿ç”¨ ECMA è§„èŒƒçš„ 10.1.8 èŠ‚ç»™å‡ºçš„å®šä¹‰å®ç°ï¼Œæ‰€ä»¥ Proxy æ˜¯ä¸€ä¸ªå¼‚è´¨å¯¹è±¡ã€‚

Proxy çš„å†…éƒ¨æ–¹æ³• `[[Get]]` ä¸æ™®é€šå¯¹è±¡çš„ä¸åŒåœ¨äºï¼Œå¦‚æœåœ¨åˆ›å»ºä»£ç†å¯¹è±¡æ—¶æ²¡æœ‰æŒ‡å®šå¯¹åº”çš„æ‹¦æˆªå‡½æ•°ï¼Œåˆ™è°ƒç”¨åŸå§‹å¯¹è±¡çš„å†…éƒ¨æ–¹æ³• `[[Get]]` æ¥è·å–å±æ€§å€¼ï¼Œè¿™å°±æ˜¯ä»£ç†é€æ˜ ğŸ«¥ æ€§è´¨ã€‚

åˆ›å»ºä»£ç†å¯¹è±¡æ—¶æŒ‡å®šçš„æ‹¦æˆªå‡½æ•°ï¼Œå®é™…ä¸Šæ˜¯ç”¨æ¥è‡ªå®šä¹‰ä»£ç†å¯¹è±¡æœ¬èº«çš„å†…éƒ¨æ–¹æ³•å’Œè¡Œä¸ºçš„ï¼Œè€Œä¸æ˜¯ç”¨æ¥æŒ‡å®šè¢«ä»£ç†å¯¹è±¡çš„å†…éƒ¨æ–¹æ³•å’Œè¡Œä¸ºã€‚

Proxy å¯¹è±¡éƒ¨ç½²çš„æ‰€æœ‰å†…éƒ¨æ–¹æ³•ï¼š

| å†…éƒ¨æ–¹æ³•                    | å¤„ç†å™¨å‡½æ•°                      |
| ----------------------- | -------------------------- |
| `[[GetprototypeOf]]`    | `getprototypeOf`           |
| `[[SetPrototypeOf]]`    | `setPrototypeOf`           |
| `[[IsExtensible]]`      | `isExtensible`             |
| `[[PreventExtensions]]` | `preventExtensions`        |
| `[[GetOwnProperty]]`    | `getOwnPropertyDescriptor` |
| `[[DefineOwnProperty]]` | `defineProperty`           |
| `[[HasProperty]]`       | `has`                      |
| `[[Get]]`               | `get`                      |
| `[[Set]]`               | `set`                      |
| `[[Delete]]`            | `deleteProperty`           |
| `[[OwnPropertyKeys]]`   | `ownKeys`                  |
| `[[Call]]`              | `apply`                    |
| `[[Construct]]`         | `construct`                |

åœ¨æ‹¦æˆªå¤„ç†å™¨å‡½æ•°çš„æ–¹æ³•æ—¶ï¼Œç”±äºå®ç°çš„æ˜¯ä»£ç†å¯¹è±¡å†…éƒ¨çš„æ–¹æ³•å’Œè¡Œä¸ºï¼Œæ‰€ä»¥ä¸ºäº†æ“ä½œä»£ç†å¯¹è±¡ä¸Šçš„å±æ€§å€¼ï¼Œéœ€è¦ä½¿ç”¨ `Reflect.deleteProperty(target, key)` æ¥å®Œæˆã€‚

### å¦‚ä½•ä»£ç† Object

#### è¯»å–

è¯»å–å±æ€§å¯ä»¥é€šè¿‡ get æ‹¦æˆªï¼š

```javascript
const obj = { foo: 1 }

const p = new Proxy(obj, {
  get(target, key, receiver) {
    // å»ºç«‹è”ç³»
    track(target, key)
    // è¿”å›å±æ€§å€¼
    return Reflect.get(target, key, receiver)
  },
})
```

#### inæ“ä½œç¬¦

in æ“ä½œç¬¦çš„è¿è¡Œæ—¶é€»è¾‘ï¼š

1. è®© lref çš„å€¼ä¸º RelationalExpression çš„æ‰§è¡Œç»“æœã€‚
2. è®© lref çš„å€¼ä¸º RelationalExpression çš„æ‰§è¡Œç»“æœã€‚
3. è®© rref çš„å€¼ä¸º ShiftExpression çš„æ‰§è¡Œç»“æœã€‚
4. è®© rval çš„å€¼ä¸º ? GetValue(rref)ã€‚
5. å¦‚æœ Type(rval) ä¸æ˜¯å¯¹è±¡ï¼Œåˆ™æŠ›å‡º TypeError å¼‚å¸¸ã€‚
6. è¿”å› `?HasProperty(rval, ? ToPropertyKey(lval))` ã€‚

in æ“ä½œç¬¦çš„è¿ç®—ç»“æœæ˜¯é€šè¿‡è°ƒç”¨ä¸€ä¸ªå«ä½œ HasProperty çš„æŠ½è±¡æ–¹æ³•å¾—åˆ°çš„ã€‚

HasProperty æŠ½è±¡æ–¹æ³•çš„é€»è¾‘ï¼š

1. æ–­è¨€ï¼šType(O) æ˜¯ Objectã€‚
2. æ–­è¨€ï¼šIsPropertyKey(P) æ˜¯ trueã€‚
3. è¿”å› `? O.[[HasProperty]](P)`ã€‚

HasProperty æŠ½è±¡æ–¹æ³•çš„è¿”å›å€¼æ˜¯é€šè¿‡è°ƒç”¨å¯¹è±¡çš„å†…éƒ¨æ–¹æ³• `[[HasProperty]]`  å¾—åˆ°çš„ã€‚å¯¹åº”çš„æ‹¦æˆªå‡½æ•°æ˜¯ `has` ã€‚

é€šè¿‡ hasæ‹¦æˆªå‡½æ•°å®ç°å¯¹ in æ“ä½œç¬¦çš„ä»£ç†ï¼š

```javascript
const obj = { foo: 1 }
const p = new Proxy(obj, {
  has(target, key) {
    track(target, key)
    return Reflect.has(target, key)
  }
})
```

#### for...in

`for...in` å¤´éƒ¨æ‰§è¡Œè§„åˆ™ä¸­ï¼Œç¬¬ 6 æ­¥ï¼š

* å¦‚æœ iterationKind æ˜¯æšä¸¾ï¼ˆenumerateï¼‰ï¼Œåˆ™
  1. å¦‚æœ exprValue æ˜¯ undefined æˆ– nullï¼Œé‚£ä¹ˆ
     1. è¿”å› `Completion { [[Type]]: break, [[Value]]: empty, [[Target]]:empty }` ã€‚
  2. è®© obj çš„å€¼ä¸º `! ToObject(exprValue)` ã€‚
  3. **è®© iterator çš„å€¼ä¸º ? `EnumerateObjectProperties(obj)` ã€‚**
  4. è®© nextMethod çš„å€¼ä¸º `! GetV(iterator, "next")` ã€‚
  5. è¿”å› `Record{ [[Iterator]]: iterator, [[NextMethod]]: nextMethod,[[Done]]: false }` ã€‚

EnumerateObjectProperties æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ï¼š

```javascript
function* EnumerateObjectProperties(obj) {
  const visited = new Set();
  for (const key of Reflect.ownKeys(obj)) {
    if (typeof key === "symbol") continue;
    const desc = Reflect.getOwnPropertyDescriptor(obj, key);
    if (desc) {
      visited.add(key);
      if (desc.enumerable) yield key;
    }
  }
  const proto = Reflect.getPrototypeOf(obj);
  if (proto === null) return;
  for (const protoKey of EnumerateObjectProperties(proto)) {
    if (!visited.has(protoKey)) yield protoKey;
  }
}
```

å…³é”®ç‚¹åœ¨äºä½¿ç”¨ `Reflect.ownKeys(obj)` æ¥è·å–åªå±äºå¯¹è±¡è‡ªèº«æ‹¥æœ‰çš„é”®ã€‚

é€šè¿‡ ownKeys æ‹¦æˆªå‡½æ•°æ¥æ‹¦æˆª Reflect.ownKeys æ“ä½œï¼š

```javascript
const obj = { foo: 1 }
const ITERATE_KEY = Symbol()

const p = new Proxy(obj, {
  ownKeys(target) {
    // å°†å‰¯ä½œç”¨å‡½æ•°ä¸ ITERATE_KEY å…³è”
    track(target, ITERATE_KEY)
    return Reflect.ownKeys(target)
  }
})
```

ownKeys ç”¨æ¥è·å–ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰å±äºè‡ªå·±çš„é”®å€¼ï¼Œåªèƒ½å¤Ÿæ„é€ å”¯ä¸€çš„ key `ITERATE_KEY` ä½œä¸ºæ ‡è¯†ã€‚åœ¨è§¦å‘å“åº”æ—¶è§¦å‘å®ƒï¼š

```javascript
trigger(target, ITERATE_KEY)
```

##### ä½¿ç”¨åœºæ™¯

å‰¯ä½œç”¨å‡½æ•°å†…æœ‰ä¸€æ®µ for...in å¾ªç¯ï¼š

```javascript
const obj = { foo: 1 }
const p = new Proxy(obj, {/* ... */})

effect(() => {
  // for...in å¾ªç¯
  for (const key in p) {
    console.log(key) // foo
  }
})
```

å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œåï¼Œä¼šä¸ `ITERATE_KEY` ä¹‹é—´å»ºç«‹å“åº”è”ç³»ï¼Œæ¥ä¸‹æ¥ä¸ºå¯¹è±¡ p æ·»åŠ æ–°çš„å±æ€§ bar ï¼š

```javascript
p.bar = 2
```

å½“æ·»åŠ å±æ€§æ—¶ï¼Œå°†é‚£äº›ä¸ `ITERATE_KEY` ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°ä¹Ÿå–å‡ºæ¥æ‰§è¡Œã€‚

ä¸æ·»åŠ æ–°å±æ€§ä¸åŒï¼Œä¿®æ”¹å±æ€§ä¸ä¼šå¯¹ `for...in` å¾ªç¯äº§ç”Ÿå½±å“ã€‚æ‰€ä»¥ä¸éœ€è¦è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œï¼Œå¦åˆ™ä¼šé€ æˆä¸å¿…è¦çš„æ€§èƒ½å¼€é”€ã€‚å½“è®¾ç½®å±æ€§æ“ä½œå‘ç”Ÿæ—¶ï¼Œéœ€è¦åœ¨ set æ‹¦æˆªå‡½æ•°å†…èƒ½å¤ŸåŒºåˆ†æ“ä½œçš„ç±»å‹ï¼š

```javascript
const p = new Proxy(obj, {
  // æ‹¦æˆªè®¾ç½®æ“ä½œ
  set(target, key, newVal, receiver) {
    // å¦‚æœå±æ€§ä¸å­˜åœ¨ï¼Œåˆ™è¯´æ˜æ˜¯åœ¨æ·»åŠ æ–°å±æ€§ï¼Œå¦åˆ™æ˜¯è®¾ç½®å·²æœ‰å±æ€§
    const type = Object.prototype.hasOwnProperty.call(target, key) ? 'SET' : 'ADD'

    // è®¾ç½®å±æ€§å€¼
    const res = Reflect.set(target, key, newVal, receiver)

    // å°† type ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ä¼ é€’ç»™ trigger å‡½æ•°
    trigger(target, key, type)

    return res
  },
  // çœç•¥å…¶ä»–æ‹¦æˆªå‡½æ•°
})
```

åœ¨ trigger å‡½æ•°å†…é€šè¿‡ç±»å‹ type æ¥åŒºåˆ†å½“å‰çš„æ“ä½œç±»å‹ï¼Œå¹¶ä¸”åªæœ‰å½“æ“ä½œç±»å‹ type ä¸º `'ADD'` æ—¶ï¼Œæ‰ä¼šè§¦å‘ä¸ `ITERATE_KEY` ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œï¼š

```javascript
01 function trigger(target, key, type) {
02   const depsMap = bucket.get(target)
03   if (!depsMap) return
04   const effects = depsMap.get(key)
05
06   const effectsToRun = new Set()
07   effects && effects.forEach(effectFn => {
08     if (effectFn !== activeEffect) {
09       effectsToRun.add(effectFn)
10     }
11   })
12
13   console.log(type, key)
14   // åªæœ‰å½“æ“ä½œç±»å‹ä¸º 'ADD' æ—¶ï¼Œæ‰è§¦å‘ä¸ ITERATE_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œ
15   if (type === 'ADD') {
16     const iterateEffects = depsMap.get(ITERATE_KEY)
17     iterateEffects && iterateEffects.forEach(effectFn => {
18       if (effectFn !== activeEffect) {
19         effectsToRun.add(effectFn)
20       }
21     })
22   }
23
24   effectsToRun.forEach(effectFn => {
25     if (effectFn.options.scheduler) {
26       effectFn.options.scheduler(effectFn)
27     } else {
28       effectFn()
29     }
30   })
31 }
```

#### åˆ é™¤å±æ€§

delete æ“ä½œç¬¦çš„è¡Œä¸ºä¸­ï¼Œç¬¬ 5 æ­¥ï¼š

* å¦‚æœ `IsPropertyReference(ref)` æ˜¯ trueï¼Œé‚£ä¹ˆ
  * æ–­è¨€ï¼š`! IsPrivateReference(ref)` æ˜¯ falseã€‚
  * å¦‚æœ `IsSuperReference(ref)` ä¹Ÿæ˜¯ trueï¼Œåˆ™æŠ›å‡º ReferenceError å¼‚å¸¸ã€‚
  * è®© baseObj çš„å€¼ä¸º `! ToObject(ref,[[Base]])` ã€‚
  * **è®© deleteStatus çš„å€¼ä¸º `? baseObj.[[Delete]](ref.[[ReferencedName]])` ã€‚**
  * å¦‚æœ deleteStatus çš„å€¼ä¸º false å¹¶ä¸” `ref.[[Strict]]` çš„å€¼æ˜¯ trueï¼Œåˆ™æŠ›å‡º TypeError å¼‚å¸¸ã€‚
  * è¿”å› deleteStatus ã€‚

delete æ“ä½œç¬¦çš„è¡Œä¸ºä¾èµ– `[[Delete]]` å†…éƒ¨æ–¹æ³•ã€‚è¯¥å†…éƒ¨æ–¹æ³•å¯ä»¥ä½¿ç”¨ `deleteProperty` æ‹¦æˆªï¼š

```javascript
const p = new Proxy(obj, {
  deleteProperty(target, key) {
    // æ£€æŸ¥è¢«æ“ä½œçš„å±æ€§æ˜¯å¦æ˜¯å¯¹è±¡è‡ªå·±çš„å±æ€§
    const hadKey = Object.prototype.hasOwnProperty.call(target, key)
    // ä½¿ç”¨ Reflect.deleteProperty å®Œæˆå±æ€§çš„åˆ é™¤
    const res = Reflect.deleteProperty(target, key)

    if (res && hadKey) {
      // åªæœ‰å½“è¢«åˆ é™¤çš„å±æ€§æ˜¯å¯¹è±¡è‡ªå·±çš„å±æ€§å¹¶ä¸”æˆåŠŸåˆ é™¤æ—¶ï¼Œæ‰è§¦å‘æ›´æ–°
      trigger(target, key, 'DELETE')
    }

    return res
  }
})
```

ç”±äºåˆ é™¤æ“ä½œä¼šä½¿å¾—å¯¹è±¡çš„é”®å˜å°‘ï¼Œå®ƒä¼šå½±å“ `for...in` å¾ªç¯çš„æ¬¡æ•°ï¼Œå› æ­¤å½“æ“ä½œç±»å‹ä¸º `'DELETE'` æ—¶ï¼Œåº”è¯¥è§¦å‘é‚£äº›ä¸ ITERATE_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œï¼š

```javascript
function trigger(target, key, type) {
  const depsMap = bucket.get(target)
  if (!depsMap) return
  const effects = depsMap.get(key)

  const effectsToRun = new Set()
  effects && effects.forEach(effectFn => {
    if (effectFn !== activeEffect) {
      effectsToRun.add(effectFn)
    }
  })

  // å½“æ“ä½œç±»å‹ä¸º ADD æˆ– DELETE æ—¶ï¼Œéœ€è¦è§¦å‘ä¸ ITERATE_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œ
  if (type === 'ADD' || type === 'DELETE') {
    const iterateEffects = depsMap.get(ITERATE_KEY)
    iterateEffects && iterateEffects.forEach(effectFn => {
      if (effectFn !== activeEffect) {
        effectsToRun.add(effectFn)
      }
    })
  }

  effectsToRun.forEach(effectFn => {
    if (effectFn.options.scheduler) {
      effectFn.options.scheduler(effectFn)
    } else {
      effectFn()
    }
  })
}
```

## åˆç†åœ°è§¦å‘å“åº”

å½“å€¼æ²¡æœ‰å˜åŒ–æ—¶ï¼Œä¸åº”è§¦å‘å“åº”ã€‚åœ¨è°ƒç”¨ trigger å‰ï¼Œæ£€æŸ¥æ˜¯å¦çœŸçš„å‘ç”Ÿå˜åŒ–ï¼Œå¹¶ä¸”åœ¨æ–°å€¼å’Œæ—§å€¼ä¸å…¨ç­‰çš„æƒ…å†µä¸‹ï¼Œä¿è¯å®ƒä»¬éƒ½ä¸æ˜¯ NaN ï¼š

```javascript
const p = new Proxy(obj, {
  set(target, key, newVal, receiver) {
    // å…ˆè·å–æ—§å€¼
    const oldVal = target[key]

    const type = Object.prototype.hasOwnProperty.call(target, key) ? 'SET' : 'ADD'
    const res = Reflect.set(target, key, newVal, receiver)
    // æ¯”è¾ƒæ–°å€¼ä¸æ—§å€¼ï¼Œåªè¦å½“ä¸å…¨ç­‰ï¼Œå¹¶ä¸”ä¸éƒ½æ˜¯ NaN çš„æ—¶å€™æ‰è§¦å‘å“åº”
    if (oldVal !== newVal && (oldVal === oldVal || newVal === newVal) {
      trigger(target, key, type)
    }

    return res
  },
})
```

å½“åŸå‹ç»§æ‰¿çš„æƒ…å†µä¸‹ä¿®æ”¹å¯¹è±¡çš„å±æ€§å€¼ï¼Œä¼šå¯¼è‡´å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œä¸¤æ¬¡ã€‚

`[[GET]]` å†…éƒ¨æ–¹æ³•çš„æ‰§è¡Œæµç¨‹ç¬¬ 3 æ­¥ï¼š

* å¦‚æœ desc æ˜¯ undefinedï¼Œé‚£ä¹ˆ
  
  * è®© parent çš„å€¼ä¸º `?O.[[GetPrototypeOf]]()`
  
  * å¦‚æœ parent æ˜¯ null ï¼Œåˆ™è¿”å› undefined ã€‚
  
  * è¿”å› `?parent.[[Get]](P,Receiver)` ã€‚

å¦‚æœå¯¹è±¡è‡ªèº«**ä¸å­˜åœ¨**è¯¥å±æ€§ï¼Œé‚£ä¹ˆä¼šè·å–å¯¹è±¡çš„åŸå‹ï¼Œå¹¶è°ƒç”¨**åŸå‹çš„ `[[GET]]`** æ–¹æ³•å¾—åˆ°æœ€ç»ˆç»“æœã€‚ç”±äº `parent` `child` éƒ½æ˜¯å“åº”å¼æ•°æ®ï¼Œ**éƒ½ä¸å‰¯ä½œç”¨å‡½æ•°å»ºç«‹äº†è”ç³»**ã€‚

å½“ä¿®æ”¹ child çš„å±æ€§å€¼æ—¶ï¼Œå¼•æ“ä¼šè°ƒç”¨ obj å¯¹è±¡éƒ¨ç½²çš„ `[[Set]]` å†…éƒ¨æ–¹æ³•ã€‚æ‰§è¡Œæµç¨‹çš„ç¬¬ 2 æ­¥ï¼š

* å¦‚æœ ownDesc æ˜¯ undefined ï¼Œé‚£ä¹ˆ
  
  * è®© parent çš„å€¼ä¸º `O.[[GetPrototypeOf]]()`
  
  * å¦‚æœ parent ä¸æ˜¯ null ï¼Œåˆ™
    
    * è¿”å› `?parent.[[Set]](P,V,Receiver)`
  
  * å¦åˆ™
    
    * å°† ownDesc è®¾ç½®ä¸º `{ [[Value]]: undefined, [[Writable]]: true, [[Enumerable]]: true, [[Configurable]]: true }`

å¦‚æœè®¾ç½®çš„å±æ€§**ä¸å­˜åœ¨**äºå¯¹è±¡ä¸Šï¼Œé‚£ä¹ˆä¼šå–å¾—å…¶**åŸå‹**ï¼Œå¹¶è°ƒç”¨**åŸå‹çš„ `[[Set]]`** æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ parent çš„ `[[Set]]` å†…éƒ¨æ–¹æ³•ã€‚ç”±äº parent æ˜¯ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥å°±ç›¸å½“äºæ‰§è¡Œäº†å®ƒçš„ set æ‹¦æˆªå‡½æ•°ã€‚å½“è¯»å– child çš„å±æ€§å€¼æ—¶ï¼Œå‰¯ä½œç”¨å‡½æ•°ä¸ä»…ä¼šè¢« child çš„å±æ€§å€¼æ”¶é›†ï¼Œä¹Ÿä¼šè¢« parent çš„å±æ€§å€¼æ”¶é›†ã€‚å½“ parent ä»£ç†å¯¹è±¡çš„ set æ‹¦æˆªå‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šè§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚

è§£å†³æ–¹æ³•å°±æ˜¯å±è”½ parent çš„å±æ€§å€¼è§¦å‘çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚åœ¨ set æ‹¦æˆªå‡½æ•°å†…åŒºåˆ†ä¸¤æ¬¡æ›´æ–°ã€‚

```javascript
// child çš„ set æ‹¦æˆªå‡½æ•°
set(target, key, value, receiver) {
  // target æ˜¯åŸå§‹å¯¹è±¡ obj
  // receiver æ˜¯ä»£ç†å¯¹è±¡ child
}
```

ç”±äº obj ä¸Šä¸å­˜åœ¨ bar å±æ€§ï¼Œæ‰€ä»¥ä¼šå–å¾— obj çš„åŸå‹parentï¼Œå¹¶æ‰§è¡Œ parent ä»£ç†å¯¹è±¡çš„ set æ‹¦æˆªå‡½æ•°ï¼š

```javascript
// parent çš„ set æ‹¦æˆªå‡½æ•°
set(target, key, value, receiver) {
  // target æ˜¯åŸå§‹å¯¹è±¡ proto
  // receiver ä»ç„¶æ˜¯ä»£ç†å¯¹è±¡ child
}
```

ç”±äºä¿®æ”¹çš„æ˜¯ child çš„å±æ€§å€¼ï¼Œæ— è®ºä»€ä¹ˆæƒ…å†µä¸‹ï¼Œreceiver éƒ½æ˜¯ child ï¼Œtarget æ˜¯å˜åŒ–çš„ã€‚åªéœ€åˆ¤æ–­ receiver æ˜¯å¦æ˜¯ target çš„ä»£ç†å¯¹è±¡ã€‚åªæœ‰å½“ receiver æ˜¯ target çš„ä»£ç†å¯¹è±¡æ‰è§¦å‘æ›´æ–°ã€‚

```javascript
function reactive(obj) {
  return new Proxy(obj {
    get(target, key, receiver) {
      // ä»£ç†å¯¹è±¡å¯ä»¥é€šè¿‡ raw å±æ€§è®¿é—®åŸå§‹æ•°æ®
      if (key === 'raw') {
        return target
      }

      track(target, key)
      return Reflect.get(target, key, receiver)
    }
    // çœç•¥å…¶ä»–æ‹¦æˆªå‡½æ•°
  })
}
```

ä»£ç†å¯¹è±¡å¯ä»¥é€šè¿‡raw å±æ€§è¯»å–åŸå§‹æ•°æ®ã€‚

```javascript
function reactive(obj) {
  return new Proxy(obj {
    set(target, key, newVal, receiver) {
      const oldVal = target[key]
      const type = Object.prototype.hasOwnProperty.call(target, key) ? 'SET' : 'ADD'
      const res = Reflect.set(target, key, newVal, receiver)

      // target === receiver.raw è¯´æ˜ receiver å°±æ˜¯ target çš„ä»£ç†å¯¹è±¡
      if (target === receiver.raw) {
        if (oldVal !== newVal && (oldVal === oldVal || newVal === newVal)) {
          trigger(target, key, type)
        }
      }

      return res
    }
    // çœç•¥å…¶ä»–æ‹¦æˆªå‡½æ•°
  })
}
```

## æµ…å“åº”ä¸æ·±å“åº”

### æ·±å“åº” Reactive

å½“ä¿®æ”¹ä¸€ä¸ªä¸‰çº§å¯¹è±¡å±æ€§å€¼æ—¶ï¼Œä¸èƒ½è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚è¯»å–ä¸‰çº§å¯¹è±¡å±æ€§æ—¶ï¼Œé¦–å…ˆè¯»å–äºŒçº§å¯¹è±¡å±æ€§ï¼Œè¿™é‡Œé€šè¿‡ `Reflect.get` è·å–åˆ°çš„ç»“æœæ˜¯ä¸€ä¸ªéå“åº”å¼å¯¹è±¡ï¼Œæ‰€ä»¥è®¿é—®ä¸‰çº§å¯¹è±¡å±æ€§æ—¶ï¼Œä¸èƒ½å»ºç«‹å“åº”å¼è”ç³»ã€‚è§£å†³è¯¥é—®é¢˜éœ€è¦å¯¹ `Reflect.get` åŒ…è£…ä¸€å±‚ï¼š

```javascript
function reactive(obj) {
  return new Proxy(obj {
    get(target, key, receiver) {
      if (key === 'raw') {
        return target
      }

      track(target, key)
      // å¾—åˆ°åŸå§‹å€¼ç»“æœ
      const res = Reflect.get(target, key, receiver)
      if (typeof res === 'object' && res !== null) {
        // è°ƒç”¨ reactive å°†ç»“æœåŒ…è£…æˆå“åº”å¼æ•°æ®å¹¶è¿”å›
        return reactive(res)
      }
      // è¿”å› res
      return res
    }
    // çœç•¥å…¶ä»–æ‹¦æˆªå‡½æ•°
  })
}
```

### æµ…å“åº” shallowReactive

æµ…å“åº”æŒ‡åªæœ‰å¯¹è±¡çš„ç¬¬ä¸€çº§å±æ€§æ˜¯å“åº”çš„ã€‚

```javascript
// å°è£… createReactive å‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªå‚æ•° isShallowï¼Œä»£è¡¨æ˜¯å¦ä¸ºæµ…å“åº”ï¼Œé»˜è®¤ä¸º falseï¼Œå³éæµ…å“åº”
function createReactive(obj, isShallow = false) {
  return new Proxy(obj, {
    // æ‹¦æˆªè¯»å–æ“ä½œ
    get(target, key, receiver) {
      if (key === 'raw') {
        return target
      }

      const res = Reflect.get(target, key, receiver)

      track(target, key)

      // å¦‚æœæ˜¯æµ…å“åº”ï¼Œåˆ™ç›´æ¥è¿”å›åŸå§‹å€¼
      if (isShallow) {
        return res
      }

      if (typeof res === 'object' && res !== null) {
        return reactive(res)
      }

      return res
    }
    // çœç•¥å…¶ä»–æ‹¦æˆªå‡½æ•°
  })
}
```

## åªè¯»å’Œæµ…åªè¯»

åªè¯»æœ¬è´¨ä¸Šä¹Ÿæ˜¯å¯¹æ•°æ®å¯¹è±¡çš„ä»£ç†ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥ä½¿ç”¨ createReactive å‡½æ•°æ¥å®ç°ã€‚

```javascript
// å¢åŠ ç¬¬ä¸‰ä¸ªå‚æ•° isReadonlyï¼Œä»£è¡¨æ˜¯å¦åªè¯»ï¼Œé»˜è®¤ä¸º falseï¼Œå³éåªè¯»
function createReactive(obj, isShallow = false, isReadonly = false) {
  return new Proxy(obj, {
    // æ‹¦æˆªè®¾ç½®æ“ä½œ
    set(target, key, newVal, receiver) {
      // å¦‚æœæ˜¯åªè¯»çš„ï¼Œåˆ™æ‰“å°è­¦å‘Šä¿¡æ¯å¹¶è¿”å›
      if (isReadonly) {
        console.warn(`å±æ€§ ${key} æ˜¯åªè¯»çš„`)
        return true
      }
      const oldVal = target[key]
      const type = Object.prototype.hasOwnProperty.call(target, key) ? 'SET' : 'ADD'
      const res = Reflect.set(target, key, newVal, receiver)
      if (target === receiver.raw) {
        if (oldVal !== newVal && (oldVal === oldVal || newVal === newVal)) {
          trigger(target, key, type)
        }
      }

      return res
    },
    deleteProperty(target, key) {
      // å¦‚æœæ˜¯åªè¯»çš„ï¼Œåˆ™æ‰“å°è­¦å‘Šä¿¡æ¯å¹¶è¿”å›
      if (isReadonly) {
        console.warn(`å±æ€§ ${key} æ˜¯åªè¯»çš„`)
        return true
      }
      const hadKey = Object.prototype.hasOwnProperty.call(target, key)
      const res = Reflect.deleteProperty(target, key)

      if (res && hadKey) {
        trigger(target, key, 'DELETE')
      }

      return res
    }
    // çœç•¥å…¶ä»–æ‹¦æˆªå‡½æ•°
  })
}
```

å¦‚æœä¸€ä¸ªæ•°æ®æ˜¯åªè¯»çš„ï¼Œé‚£å°±æ„å‘³ç€ä»»ä½•æ–¹å¼éƒ½æ— æ³•ä¿®æ”¹å®ƒã€‚å› æ­¤ï¼Œæ²¡æœ‰å¿…è¦ä¸ºåªè¯»æ•°æ®å»ºç«‹å“åº”è”ç³»ã€‚

```javascript
function createReactive(obj, isShallow = false, isReadonly = false) {
  return new Proxy(obj, {
    // æ‹¦æˆªè¯»å–æ“ä½œ
    get(target, key, receiver) {
      if (key === 'raw') {
        return target
      }
      if (!isReadonly) {
        track(target, key)
      }

      const res = Reflect.get(target, key, receiver)

      if (isShallow) {
        return res
      }

      if (typeof res === 'object' && res !== null) {
        // å¦‚æœæ•°æ®ä¸ºåªè¯»ï¼Œåˆ™è°ƒç”¨ readonly å¯¹å€¼è¿›è¡ŒåŒ…è£…
        return isReadonly ? readonly(res) : reactive(res)
      }

      return res
    }
    // çœç•¥å…¶ä»–æ‹¦æˆªå‡½æ•°
  })
}
```

shallowReadonly åªéœ€è¦ä¿®æ”¹ createReactive çš„ç¬¬äºŒä¸ªå‚æ•°å³å¯ï¼š

```javascript
function readonly(obj) {
  return createReactive(obj, false, true)
}

function shallowReadonly(obj) {
  return createReactive(obj, true /* shallow */, true)
}
```

## ä»£ç†æ•°ç»„

æ•°ç»„æ˜¯ä¸ªå¼‚è´¨å¯¹è±¡ï¼Œå› ä¸ºæ•°ç»„å¯¹è±¡çš„ `[[DefineOwnProperty]]` å†…éƒ¨æ–¹æ³•ä¸å¸¸è§„å¯¹è±¡ä¸åŒï¼Œå…¶ä»–å†…éƒ¨æ–¹æ³•çš„é€»è¾‘éƒ½ä¸å¸¸è§„å¯¹è±¡ç›¸åŒã€‚å®ç°å¯¹æ•°ç»„çš„ä»£ç†æ—¶ï¼Œç”¨äºä»£ç†æ™®é€šå¯¹è±¡çš„å¤§éƒ¨åˆ†ä»£ç å¯ä»¥ç»§ç»­ä½¿ç”¨ã€‚

å¯¹æ•°ç»„å…ƒç´ æˆ–å±æ€§çš„â€œè¯»å–â€æ“ä½œï¼š

* é€šè¿‡ç´¢å¼•è®¿é—®æ•°ç»„å…ƒç´ å€¼ï¼š`arr[0]` ã€‚
* è®¿é—®æ•°ç»„çš„é•¿åº¦ï¼š`arr.length` ã€‚
* æŠŠæ•°ç»„ä½œä¸ºå¯¹è±¡ï¼Œä½¿ç”¨ `for...in` å¾ªç¯éå†ã€‚
* ä½¿ç”¨ `for...of` è¿­ä»£éå†æ•°ç»„ã€‚
* æ•°ç»„çš„åŸå‹æ–¹æ³•ï¼Œå¦‚ concat/join/every/some/find/findIndex/includes ç­‰ï¼Œä»¥åŠå…¶ä»–æ‰€æœ‰ä¸æ”¹å˜åŸæ•°ç»„çš„åŸå‹æ–¹æ³•ã€‚

å¯¹æ•°ç»„å…ƒç´ æˆ–å±æ€§çš„è®¾ç½®æ“ä½œï¼š

* é€šè¿‡ç´¢å¼•ä¿®æ”¹æ•°ç»„å…ƒç´ å€¼ï¼š`arr[1] = 3` ã€‚
* ä¿®æ”¹æ•°ç»„é•¿åº¦ï¼š`arr.length = 0` ã€‚
* æ•°ç»„çš„æ ˆæ–¹æ³•ï¼špush/pop/shift/unshift ã€‚
* ä¿®æ”¹åŸæ•°ç»„çš„åŸå‹æ–¹æ³•ï¼šsplice/fill/sort ç­‰ã€‚

### æ•°ç»„çš„ç´¢å¼•ä¸ length

æ•°ç»„å¯¹è±¡éƒ¨ç½²çš„å†…éƒ¨æ–¹æ³• `[[DefineOwnProperty]]` ä¸åŒäºå¸¸è§„å¯¹è±¡ã€‚é€šè¿‡ç´¢å¼•è®¾ç½®æ•°ç»„å…ƒç´ çš„å€¼ï¼Œä¼šæ‰§è¡Œæ•°ç»„å¯¹è±¡æ‰€éƒ¨ç½²çš„å†…éƒ¨æ–¹æ³• `[[Set]]` ï¼Œä¸è®¾ç½®å¸¸è§„å¯¹è±¡çš„å±æ€§å€¼ä¸€æ ·ã€‚å†…éƒ¨æ–¹æ³• `[[Set]]` å…¶å®ä¾èµ–äº`[[DefineOwnProperty]]` ï¼Œè¯¥æ–¹æ³•ä½“ç°å‡ºäº†å·®å¼‚ã€‚

`[[DefineOwnProperty]]` å†…éƒ¨æ–¹æ³•çš„æ‰§è¡Œæµç¨‹ï¼š

ç¬¬ 3 æ­¥çš„ j å­æ­¥éª¤æè¿°çš„å†…å®¹å¦‚ä¸‹ï¼š

j. å¦‚æœ `index >= oldLen` ï¼Œé‚£ä¹ˆ

â€‹	I. å°† `oldLenDesc.[[Value]]` è®¾ç½®ä¸º `index + 1` ã€‚

â€‹	II. è®© succeeded çš„å€¼ä¸º `OrdinaryDefineOwnProperty(A, ''length'',oldLenDesc)` ã€‚

â€‹	III. æ–­è¨€ï¼šsucceeded æ˜¯ trueã€‚

å¦‚æœè®¾ç½®çš„ç´¢å¼•å€¼å¤§äºæ•°ç»„å½“å‰çš„é•¿åº¦ï¼Œé‚£ä¹ˆè¦æ›´æ–°æ•°ç»„çš„ `length` å±æ€§ã€‚å½“é€šè¿‡ç´¢å¼•è®¾ç½®å…ƒç´ å€¼æ—¶ï¼Œå¯èƒ½ä¼šéšå¼åœ°ä¿®æ”¹ `length` çš„å±æ€§å€¼ã€‚length è¢«ä¿®æ”¹éœ€è¦è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚éœ€è¦ä¿®æ”¹ set æ‹¦æˆªå‡½æ•°å®ç°ã€‚

```javascript
function createReactive(obj, isShallow = false, isReadonly = false) {
  return new Proxy(obj, {
    // æ‹¦æˆªè®¾ç½®æ“ä½œ
    set(target, key, newVal, receiver) {
      if (isReadonly) {
        console.warn(`å±æ€§ ${key} æ˜¯åªè¯»çš„`)
        return true
      }
      const oldVal = target[key]
      // å¦‚æœå±æ€§ä¸å­˜åœ¨ï¼Œåˆ™è¯´æ˜æ˜¯åœ¨æ·»åŠ æ–°çš„å±æ€§ï¼Œå¦åˆ™æ˜¯è®¾ç½®å·²æœ‰å±æ€§
      const type = Array.isArray(target)
        // å¦‚æœä»£ç†ç›®æ ‡æ˜¯æ•°ç»„ï¼Œåˆ™æ£€æµ‹è¢«è®¾ç½®çš„ç´¢å¼•å€¼æ˜¯å¦å°äºæ•°ç»„é•¿åº¦ï¼Œ
        // å¦‚æœæ˜¯ï¼Œåˆ™è§†ä½œ SET æ“ä½œï¼Œå¦åˆ™æ˜¯ ADD æ“ä½œ
        ? Number(key) < target.length ? 'SET' : 'ADD'
        : Object.prototype.hasOwnProperty.call(target, key) ? 'SET' : 'ADD'

      const res = Reflect.set(target, key, newVal, receiver)
      if (target === receiver.raw) {
        if (oldVal !== newVal && (oldVal === oldVal || newVal === newVal)) {
          trigger(target, key, type)
        }
      }

      return res
    }
    // çœç•¥å…¶ä»–æ‹¦æˆªå‡½æ•°
}
```

åœ¨ trigger å‡½æ•°ä¸­æ­£ç¡®åœ°è§¦å‘ä¸æ•°ç»„å¯¹è±¡çš„ length å±æ€§ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œï¼š

```javascript
function trigger(target, key, type) {
  const depsMap = bucket.get(target)
  if (!depsMap) return
  // çœç•¥éƒ¨åˆ†å†…å®¹

  // å½“æ“ä½œç±»å‹ä¸º ADD å¹¶ä¸”ç›®æ ‡å¯¹è±¡æ˜¯æ•°ç»„æ—¶ï¼Œåº”è¯¥å–å‡ºå¹¶æ‰§è¡Œé‚£äº›ä¸ length å±æ€§ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°
  if (type === 'ADD' && Array.isArray(target)) {
    // å–å‡ºä¸ length ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°
    const lengthEffects = depsMap.get('length')
    // å°†è¿™äº›å‰¯ä½œç”¨å‡½æ•°æ·»åŠ åˆ° effectsToRun ä¸­ï¼Œå¾…æ‰§è¡Œ
    lengthEffects && lengthEffects.forEach(effectFn => {
      if (effectFn !== activeEffect) {
        effectsToRun.add(effectFn)
      }
    })
  }

  effectsToRun.forEach(effectFn => {
    if (effectFn.options.scheduler) {
      effectFn.options.scheduler(effectFn)
    } else {
      effectFn()
    }
  })
}
```

ä¿®æ”¹æ•°ç»„çš„ `length` å±æ€§ä¹Ÿä¼šéšå¼åœ°å½±å“æ•°ç»„å…ƒç´ ã€‚å½“ä¿®æ”¹ `length` å±æ€§å€¼æ—¶ï¼Œåªæœ‰é‚£äº›ç´¢å¼•å€¼å¤§äºæˆ–ç­‰äºæ–°çš„ `length` å±æ€§å€¼çš„å…ƒç´ æ‰éœ€è¦è§¦å‘å“åº”ã€‚åœ¨è°ƒç”¨ trigger å‡½æ•°è§¦å‘å“åº”æ—¶ï¼Œåº”è¯¥æŠŠæ–°çš„å±æ€§å€¼ä¼ é€’è¿‡å»ï¼š

```javascript
function createReactive(obj, isShallow = false, isReadonly = false) {
  return new Proxy(obj, {
    // æ‹¦æˆªè®¾ç½®æ“ä½œ
    set(target, key, newVal, receiver) {
      if (isReadonly) {
        console.warn(`å±æ€§ ${key} æ˜¯åªè¯»çš„`)
        return true
      }
      const oldVal = target[key]

      const type = Array.isArray(target)
        ? Number(key) < target.length ? 'SET' : 'ADD'
        : Object.prototype.hasOwnProperty.call(target, key) ? 'SET' : 'ADD'

      const res = Reflect.set(target, key, newVal, receiver)
      if (target === receiver.raw) {
        if (oldVal !== newVal && (oldVal === oldVal || newVal === newVal)) {
          // å¢åŠ ç¬¬å››ä¸ªå‚æ•°ï¼Œå³è§¦å‘å“åº”çš„æ–°å€¼
          trigger(target, key, type, newVal)
        }
      }

      return res
    },
  })
}
```

ä¿®æ”¹ trigger å‡½æ•°ï¼š

```javascript
// ä¸º trigger å‡½æ•°å¢åŠ ç¬¬å››ä¸ªå‚æ•°ï¼ŒnewValï¼Œå³æ–°å€¼
function trigger(target, key, type, newVal) {
  const depsMap = bucket.get(target)
  if (!depsMap) return
  // çœç•¥å…¶ä»–ä»£ç 

  // å¦‚æœæ“ä½œç›®æ ‡æ˜¯æ•°ç»„ï¼Œå¹¶ä¸”ä¿®æ”¹äº†æ•°ç»„çš„ length å±æ€§
  if (Array.isArray(target) && key === 'length') {
    // å¯¹äºç´¢å¼•å¤§äºæˆ–ç­‰äºæ–°çš„ length å€¼çš„å…ƒç´ ï¼Œ
    // éœ€è¦æŠŠæ‰€æœ‰ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°å–å‡ºå¹¶æ·»åŠ åˆ° effectsToRun ä¸­å¾…æ‰§è¡Œ
    depsMap.forEach((effects, key) => {
      if (key >= newVal) {
        effects.forEach(effectFn => {
          if (effectFn !== activeEffect) {
            effectsToRun.add(effectFn)
          }
        })
      }
    })
  }

  effectsToRun.forEach(effectFn => {
    if (effectFn.options.scheduler) {
      effectFn.options.scheduler(effectFn)
    } else {
      effectFn()
    }
  })
}
```

æ–°å€¼æŒ‡çš„æ˜¯æ–°çš„ `length` å±æ€§å€¼ï¼Œå®ƒä»£è¡¨æ–°çš„æ•°ç»„é•¿åº¦ã€‚æ¥ç€ï¼Œæˆ‘ä»¬åˆ¤æ–­æ“ä½œçš„ç›®æ ‡æ˜¯å¦æ˜¯æ•°ç»„ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™éœ€è¦æ‰¾åˆ°æ‰€æœ‰ç´¢å¼•å€¼å¤§äºæˆ–ç­‰äºæ–°çš„ `length` å€¼çš„å…ƒç´ ï¼Œç„¶åæŠŠä¸å®ƒä»¬ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°å–å‡ºå¹¶æ‰§è¡Œã€‚

### éå†æ•°ç»„

æ•°ç»„ä¹Ÿæ˜¯å¯¹è±¡ï¼ŒåŒæ ·å¯ä»¥ä½¿ç”¨ for...in å¾ªç¯éå†ã€‚å®é™…åº”è¯¥å°½é‡é¿å…ä½¿ç”¨ for...in å¾ªç¯éå†æ•°ç»„ã€‚æ•°ç»„å¯¹è±¡å’Œå¸¸è§„å¯¹è±¡çš„ä¸åŒä»…ä½“ç°åœ¨ `[[DefineOwnProperty]]` ï¼Œæ‰€ä»¥ for...in å¾ªç¯éå†æ•°ç»„ä¸éå†å¸¸è§„å¯¹è±¡å¹¶æ— å·®å¼‚ï¼Œå¯ä»¥ä½¿ç”¨ `ownKeys` æ‹¦æˆªå‡½æ•°è¿›è¡Œæ‹¦æˆªã€‚

```javascript
function createReactive(obj, isShallow = false, isReadonly = false) {
  return new Proxy(obj, {
    // çœç•¥å…¶ä»–æ‹¦æˆªå‡½æ•°
    ownKeys(target) {
      track(target, ITERATE_KEY)
      return Reflect.ownKeys(target)
    }
  })
}
```

å¯¹äºä¸€ä¸ªæ™®é€šå¯¹è±¡æ¥è¯´ï¼Œåªæœ‰å½“æ·»åŠ æˆ–åˆ é™¤å±æ€§å€¼æ—¶æ‰ä¼šå½±å“ for...in å¾ªç¯çš„ç»“æœã€‚æ‰€ä»¥å½“æ·»åŠ æˆ–åˆ é™¤å±æ€§æ“ä½œå‘ç”Ÿæ—¶ï¼Œéœ€è¦å–å‡ºä¸ ITERATE_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚å¯¹äºæ•°ç»„æƒ…å†µæœ‰æ‰€ä¸åŒï¼Œå½±å“ for...in å¾ªç¯å¯¹æ•°ç»„çš„éå†çš„æ“ä½œï¼š

â— æ·»åŠ æ–°å…ƒç´ ï¼š`arr[100] = 'bar'` ã€‚

â— ä¿®æ”¹æ•°ç»„é•¿åº¦ï¼š`arr.length = 0` ã€‚

æœ¬è´¨ä¸Šéƒ½æ˜¯å› ä¸ºä¿®æ”¹äº†æ•°ç»„çš„ `length` å±æ€§ï¼Œ`for...in` å¾ªç¯å¯¹æ•°ç»„çš„éå†ç»“æœå°±ä¼šæ”¹å˜ï¼Œåº”è¯¥è§¦å‘å“åº”ã€‚å¯ä»¥åœ¨ `ownKeys` æ‹¦æˆªå‡½æ•°å†…ï¼Œåˆ¤æ–­å½“å‰æ“ä½œç›®æ ‡ target æ˜¯å¦æ˜¯æ•°ç»„ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä½¿ç”¨ `length` ä½œä¸º key å»å»ºç«‹å“åº”è”ç³»ï¼š

```javascript
function createReactive(obj, isShallow = false, isReadonly = false) {
  return new Proxy(obj, {
    // çœç•¥å…¶ä»–æ‹¦æˆªå‡½æ•°
    ownKeys(target) {
      // å¦‚æœæ“ä½œç›®æ ‡ target æ˜¯æ•°ç»„ï¼Œåˆ™ä½¿ç”¨ length å±æ€§ä½œä¸º key å¹¶å»ºç«‹å“åº”è”ç³»
      track(target, Array.isArray(target) ? 'length' : ITERATE_KEY)
      return Reflect.ownKeys(target)
    }
  })
}
```

`for...of` æ˜¯ç”¨æ¥éå†å¯è¿­ä»£å¯¹è±¡ï¼ˆiterable objectï¼‰çš„ã€‚ES2015 ä¸º JavaScript å®šä¹‰äº†è¿­ä»£åè®®ï¼ˆiteration protocolï¼‰ã€‚ä¸€ä¸ªå¯¹è±¡èƒ½å¦è¢«è¿­ä»£ï¼Œå–å†³äºè¯¥å¯¹è±¡æˆ–è€…è¯¥å¯¹è±¡çš„åŸå‹æ˜¯å¦å®ç°äº† `@@iterator` æ–¹æ³•ã€‚è¿™é‡Œçš„`@@[name]` æ ‡å¿—åœ¨ ECMAScript è§„èŒƒé‡Œç”¨æ¥ä»£æŒ‡ JavaScript å†…å»ºçš„ symbols å€¼ï¼Œå¦‚ @@iterator æŒ‡çš„å°±æ˜¯ Symbol.iterator è¿™ä¸ªå€¼ã€‚

å¯¹æ•°ç»„è¿›è¡Œ `for...of` éå†æ“ä½œçš„æ‹¦æˆªï¼Œå…³é”®ç‚¹åœ¨äºæ‰¾åˆ° `for...of` æ“ä½œä¾èµ–çš„åŸºæœ¬è¯­ä¹‰ã€‚

æ•°ç»„è¿­ä»£å™¨çš„æ‰§è¡Œä¼šè¯»å–æ•°ç»„çš„ `length` å±æ€§ã€‚å¦‚æœè¿­ä»£çš„æ˜¯æ•°ç»„å…ƒç´ å€¼ï¼Œè¿˜ä¼šè¯»å–æ•°ç»„çš„ç´¢å¼•ã€‚

```javascript
const arr = [1, 2, 3, 4, 5]

arr[Symbol.iterator] = function() {
  const target = this
  const len = target.length
  let index = 0

  return {
    next() {
      return {
        value: index < len ? target[index] : undefined,
        done: index++ >= len
      }
    }
  }
}
```

ç”¨è‡ªå®šä¹‰çš„å®ç°è¦†ç›–äº†æ•°ç»„å†…å»ºçš„è¿­ä»£å™¨æ–¹æ³•ã€‚

è¿­ä»£æ•°ç»„æ—¶ï¼Œåªéœ€è¦åœ¨**å‰¯ä½œç”¨å‡½æ•°ä¸æ•°ç»„çš„é•¿åº¦**å’Œ**ç´¢å¼•**ä¹‹é—´**å»ºç«‹å“åº”è”ç³»**ï¼Œå°±èƒ½å¤Ÿå®ç°å“åº”å¼çš„ `for...of` è¿­ä»£ã€‚åªè¦æ•°ç»„çš„é•¿åº¦å’Œå…ƒç´ å€¼å‘ç”Ÿæ”¹å˜ï¼Œå‰¯ä½œç”¨å‡½æ•°è‡ªç„¶ä¼šé‡æ–°æ‰§è¡Œã€‚

æ•°ç»„çš„ values æ–¹æ³•çš„è¿”å›å€¼å®é™…ä¸Šå°±æ˜¯æ•°ç»„å†…å»ºçš„è¿­ä»£å™¨ï¼Œæ— è®ºæ˜¯ä½¿ç”¨ `for...of` å¾ªç¯ï¼Œè¿˜æ˜¯è°ƒç”¨ `values` ç­‰æ–¹æ³•ï¼Œå®ƒä»¬éƒ½ä¼šè¯»å–æ•°ç»„çš„ `Symbol.iterator` å±æ€§ã€‚è¯¥å±æ€§æ˜¯ä¸€ä¸ª symbol å€¼ï¼Œä¸ºäº†é¿å…å‘ç”Ÿæ„å¤–çš„é”™è¯¯ï¼Œä»¥åŠæ€§èƒ½ä¸Šçš„è€ƒè™‘ï¼š

```javascript
function createReactive(obj, isShallow = false, isReadonly = false) {
  return new Proxy(obj, {
    // æ‹¦æˆªè¯»å–æ“ä½œ
    get(target, key, receiver) {
      console.log('get: ', key)
      if (key === 'raw') {
        return target
      }

      // æ·»åŠ åˆ¤æ–­ï¼Œå¦‚æœ key çš„ç±»å‹æ˜¯ symbolï¼Œåˆ™ä¸è¿›è¡Œè¿½è¸ª
      if (!isReadonly && typeof key !== 'symbol') {
        track(target, key)
      }

      const res = Reflect.get(target, key, receiver)

      if (isShallow) {
        return res
      }

      if (typeof res === 'object' && res !== null) {
        return isReadonly ? readonly(res) : reactive(res)
      }

      return res
    },
  })
}
```

åœ¨è°ƒç”¨ track å‡½æ•°è¿›è¡Œè¿½è¸ªä¹‹å‰ï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œå³åªæœ‰å½“ `key` çš„ç±»å‹ä¸æ˜¯ symbol æ—¶æ‰è¿›è¡Œè¿½è¸ªã€‚

### æ•°ç»„çš„æŸ¥æ‰¾æ–¹æ³•
